{% extends 'base.html' %}
{% load static %}
{% load core_extras %}

{% block title %}Dashboard - School Management System{% endblock %}

{% block extra_css %}
<style>
    .quick-action-btn {
        padding: 15px;
        border-radius: 10px;
        transition: all 0.3s ease;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        border-left: 5px solid #2B579A;
    }

    .quick-action-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .admin-section {
        display: none;
    }

    .stats-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 24px;
        margin-right: 15px;
    }

    .activity-timeline {
        position: relative;
    }

    .activity-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 20px;
        width: 2px;
        background-color: #e9ecef;
    }

    .activity-item {
        position: relative;
        padding-left: 45px;
        margin-bottom: 20px;
    }

    .activity-item::before {
        content: '';
        position: absolute;
        left: 12px;
        top: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #6c757d;
    }

    .activity-item.success::before {
        border-color: #28a745;
    }

    .activity-item.danger::before {
        border-color: #dc3545;
    }

    .activity-item.warning::before {
        border-color: #ffc107;
    }

    .activity-item.info::before {
        border-color: #17a2b8;
    }

    .system-status {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .system-status i {
        margin-right: 10px;
    }

    .system-status.active {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .system-status.inactive {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .system-status.warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    /* Attendance Chart Styles */
    .attendance-chart-card {
        background-color: #faf8f5;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }

    .attendance-chart-header {
        padding: 20px 25px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .attendance-chart-header h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 0;
    }

    .attendance-chart-body {
        padding: 20px 25px;
        position: relative;
    }

    .attendance-filters {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .attendance-filters select,
    .attendance-filters input[type="date"],
    .attendance-filters button {
        border-radius: 8px;
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        background-color: #ffffff;
        font-size: 14px;
    }

    .attendance-filters input[type="date"] {
        padding: 7px 8px;
    }

    .attendance-filters button {
        background-color: #6f42c1;
        color: white;
        border: none;
        transition: all 0.2s ease;
    }

    .attendance-filters button:hover {
        background-color: #5a32a3;
    }

    .attendance-filters button:disabled {
        background-color: #b392f0;
        cursor: not-allowed;
    }

    .date-range-selector {
        display: flex;
        align-items: center;
        background-color: #ffffff;
        border-radius: 8px;
        padding: 2px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .attendance-tooltip {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        pointer-events: none;
        z-index: 100;
        display: none;
    }

    .chart-container {
        height: 350px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
{% if user.is_superuser or user.is_staff %}
<!-- Admin Dashboard Section -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card bg-primary text-white"
            style="background: linear-gradient(45deg, #6f42c1, #6610f2) !important; border: none;">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        {% if request.user.teacher.profile_picture %}
                        <img src="{{ request.user.teacher.profile_picture.url }}" alt="Admin Profile"
                            class="rounded-circle" width="80" height="80">
                        {% else %}
                        <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center"
                            style="width: 80px; height: 80px;">
                            <i class="fas fa-user-shield fa-2x"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-2">Welcome, {{ request.user.get_full_name|default:request.user.username }}!
                        </h3>
                        <p class="mb-0 opacity-75">Administrator</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="badge bg-white text-primary" style="font-size: 0.9rem; padding: 8px 15px;">
                            <i class="fas fa-star me-1"></i>Admin Dashboard
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary-light text-primary">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div>
                        <h5 class="card-title">Students</h5>
                        <h3 class="mb-0">{{ student_count }}</h3>
                        <p class="text-muted mb-0">Active: {{ student_count }}</p>
                    </div>
                </div>
                <a href="{% url 'students:student_list' %}" class="btn btn-sm btn-outline-primary mt-3">View All</a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success-light text-success">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div>
                        <h5 class="card-title">Teachers</h5>
                        <h3 class="mb-0">{{ teacher_count }}</h3>
                        <p class="text-muted mb-0">Active: {{ teacher_count }}</p>
                    </div>
                </div>
                <a href="{% url 'school_teachers:teacher_list' %}" class="btn btn-sm btn-outline-success mt-3">View
                    All</a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning-light text-warning">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>
                        <h5 class="card-title">Subjects</h5>
                        <h3 class="mb-0">{{ subject_count }}</h3>
                        <p class="text-muted mb-0">Active: {{ subject_count }}</p>
                    </div>
                </div>
                <a href="{% url 'subjects:subject_list' %}" class="btn btn-sm btn-outline-warning mt-3">View All</a>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger-light text-danger">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div>
                        <h5 class="card-title">Revenue</h5>
                        <h3 class="mb-0">â‚¹{{ total_revenue|default:"0.00"|floatformat:2 }}</h3>
                        <p class="text-muted mb-0">Total Fee Collection</p>
                    </div>
                </div>
                <a href="{% url 'fees:fee_payment_list' %}" class="btn btn-sm btn-outline-danger mt-3">View All</a>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Chart Section (Admin Only) -->
<div class="row">
    <div class="col-12">
        <div class="attendance-chart-card">
            <div class="attendance-chart-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>ATTENDANCE</h2>
                    <div class="attendance-filters">
                        <div class="view-selector me-3">
                            <select id="chartViewSelector" class="form-select">
                                <option value="all">All Data</option>
                                <option value="students">Students Only</option>
                                <option value="teachers">Teachers Only</option>
                                <option value="present">Present Only</option>
                                <option value="absent">Absent Only</option>
                            </select>
                        </div>
                        <div class="date-range-selector d-flex align-items-center">
                            <input type="date" id="startDate" class="form-control me-1" style="max-width: 150px;"
                                value="{{ attendance_chart_data.start_date }}">
                            <span class="px-1">to</span>
                            <input type="date" id="endDate" class="form-control me-2" style="max-width: 150px;"
                                value="{{ attendance_chart_data.end_date }}">
                            <button type="button" id="updateDateRange" class="btn btn-sm btn-primary">Apply</button>
                        </div>
                        <button type="button" id="printAttendanceChart" class="btn btn-sm btn-secondary ms-2"
                            title="Print Attendance Report">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="attendance-chart-body">
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                    <div id="tooltip" class="attendance-tooltip"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="{% url 'students:student_create' %}"
                            class="quick-action-btn d-block text-decoration-none">
                            <div class="d-flex align-items-center">
                                <div class="icon bg-primary-light text-primary me-3 p-2 rounded">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Add New Student</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'school_teachers:teacher_create' %}"
                            class="quick-action-btn d-block text-decoration-none">
                            <div class="d-flex align-items-center">
                                <div class="icon bg-success-light text-success me-3 p-2 rounded">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Add New Teacher</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'subjects:subject_create' %}"
                            class="quick-action-btn d-block text-decoration-none">
                            <div class="d-flex align-items-center">
                                <div class="icon bg-warning-light text-warning me-3 p-2 rounded">
                                    <i class="fas fa-book-medical"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Add New Subject</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'events:event_create' %}" class="quick-action-btn d-block text-decoration-none">
                            <div class="d-flex align-items-center">
                                <div class="icon bg-info-light text-info me-3 p-2 rounded">
                                    <i class="fas fa-calendar-plus"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Add New Event</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">System Status</h5>
            </div>
            <div class="card-body">
                <div class="system-status active">
                    <i class="fas fa-check-circle"></i>
                    <span>Database Connection: Online</span>
                </div>

                <div class="text-center mt-3">
                    <a href="{% url 'admin:index' %}" class="btn btn-primary">Go to Admin Panel</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Class Distribution</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Number of Students</th>
                                <th>Percentage</th>
                                <th>Teachers Assigned</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for class in class_distribution %}
                            <tr>
                                <td>
                                    {% if class.class_name == '1' %}Class 1
                                    {% elif class.class_name == '2' %}Class 2
                                    {% elif class.class_name == '3' %}Class 3
                                    {% elif class.class_name == '4' %}Class 4
                                    {% elif class.class_name == '5' %}Class 5
                                    {% else %}Class {{ class.class_name }}
                                    {% endif %}
                                </td>
                                <td>{{ class.count }}</td>
                                <td>
                                    {% if student_count > 0 %}
                                    {{ class.count|multiply:100|divide:student_count|floatformat:1 }}%
                                    {% else %}
                                    0%
                                    {% endif %}
                                </td>
                                <td>{{ class.teacher_count|default:"5" }}</td>
                                <td>
                                    <a href="{% url 'timetable:class_timetable' %}?class={{ class.class_name }}"
                                        class="btn btn-sm btn-info">
                                        <i class="fas fa-calendar"></i> View Timetable
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No class data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Recent Activities</h5>
            </div>
            <div class="card-body">
                <div class="activity-timeline">
                    <div class="activity-item success">
                        <p class="mb-0">New student registered</p>
                        <small class="text-muted">30 minutes ago</small>
                    </div>
                    <div class="activity-item info">
                        <p class="mb-0">Fee payment received</p>
                        <small class="text-muted">2 hours ago</small>
                    </div>
                    <div class="activity-item warning">
                        <p class="mb-0">New event created</p>
                        <small class="text-muted">Yesterday</small>
                    </div>
                    <div class="activity-item danger">
                        <p class="mb-0">System backup completed</p>
                        <small class="text-muted">2 days ago</small>
                    </div>
                    <div class="activity-item">
                        <p class="mb-0">Teacher profile updated</p>
                        <small class="text-muted">3 days ago</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Upcoming Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in upcoming_events %}
                            <tr>
                                <td>{{ event.title }}</td>
                                <td>{{ event.start_date|date:"d M Y" }}</td>
                                <td>
                                    <span class="badge 
                                    {% if event.event_type == 'academic' %}bg-primary
                                    {% elif event.event_type == 'sports' %}bg-success
                                    {% elif event.event_type == 'cultural' %}bg-warning
                                    {% elif event.event_type == 'holiday' %}bg-danger
                                    {% else %}bg-info{% endif %}">
                                        {{ event.get_event_type_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No upcoming events</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Ongoing Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>End Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in ongoing_events %}
                            <tr>
                                <td>{{ event.title }}</td>
                                <td>{{ event.end_date|date:"d M Y" }}</td>
                                <td>
                                    <span class="badge 
                                    {% if event.event_type == 'academic' %}bg-primary
                                    {% elif event.event_type == 'sports' %}bg-success
                                    {% elif event.event_type == 'cultural' %}bg-warning
                                    {% elif event.event_type == 'holiday' %}bg-danger
                                    {% else %}bg-info{% endif %}">
                                        {{ event.get_event_type_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No ongoing events</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Permissions Management Section (Admin Only) -->
{% if request.user.is_staff or request.user.is_superuser %}
<div class="row">
    <div class="col-12 col-lg-12 col-xl-12">
        <div class="card flex-fill">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title">User Permissions</h5>
                    </div>
                    <div class="col-auto">
                        <a href="{% url 'core:user_permissions' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-cog mr-1"></i> Manage Permissions
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i>
                            Manage permissions for all users - assign roles, restrict access, and control system
                            privileges
                        </div>
                        <p>As an administrator, you can:</p>
                        <ul>
                            <li>View all system users (students, teachers, and others)</li>
                            <li>Assign user roles (student, teacher, admin)</li>
                            <li>Control access to system features</li>
                            <li>Manage permissions for newly registered users</li>
                        </ul>
                        <div class="text-center mt-3">
                            <a href="{% url 'core:user_permissions' %}" class="btn btn-outline-primary">
                                <i class="fas fa-users-cog mr-1"></i> Go to Permissions Management
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% else %}
<!-- Regular Dashboard for non-admin users -->
<div class="row">
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-primary border-primary">
                        <i class="fas fa-user-graduate"></i>
                    </span>
                    <div class="dash-count">
                        <h3>{{ student_count }}</h3>
                        <h6 class="text-muted">Students</h6>
                    </div>
                </div>
                <p class="text-muted mt-3 mb-0">
                    <span class="text-success me-1">
                        <i class="fas fa-arrow-up"></i>
                    </span>
                    Active Students
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-success border-success">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </span>
                    <div class="dash-count">
                        <h3>{{ teacher_count }}</h3>
                        <h6 class="text-muted">Teachers</h6>
                    </div>
                </div>
                <p class="text-muted mt-3 mb-0">
                    <span class="text-success me-1">
                        <i class="fas fa-arrow-up"></i>
                    </span>
                    Active Teachers
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-warning border-warning">
                        <i class="fas fa-book"></i>
                    </span>
                    <div class="dash-count">
                        <h3>{{ subject_count }}</h3>
                        <h6 class="text-muted">Subjects</h6>
                    </div>
                </div>
                <p class="text-muted mt-3 mb-0">
                    <span class="text-success me-1">
                        <i class="fas fa-arrow-up"></i>
                    </span>
                    Active Subjects
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-danger border-danger">
                        <i class="fas fa-dollar-sign"></i>
                    </span>
                    <div class="dash-count">
                        <h3>â‚¹{{ total_revenue|default:"0.00"|floatformat:2 }}</h3>
                        <h6 class="text-muted">Revenue</h6>
                    </div>
                </div>
                <p class="text-muted mt-3 mb-0">
                    <span class="text-success me-1">
                        <i class="fas fa-arrow-up"></i>
                    </span>
                    Total Fee Collection
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <h4 class="card-title float-start">Class Distribution</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Number of Students</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for class in class_distribution %}
                            <tr>
                                <td>
                                    {% if class.class_name == '1' %}Class 1
                                    {% elif class.class_name == '2' %}Class 2
                                    {% elif class.class_name == '3' %}Class 3
                                    {% elif class.class_name == '4' %}Class 4
                                    {% elif class.class_name == '5' %}Class 5
                                    {% else %}Class {{ class.class_name }}
                                    {% endif %}
                                </td>
                                <td>{{ class.count }}</td>
                                <td>
                                    {% if student_count > 0 %}
                                    {{ class.count|multiply:100|divide:student_count|floatformat:1 }}%
                                    {% else %}
                                    0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No class data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <h4 class="card-title">Recent Fee Payments</h4>
            </div>
            <div class="card-body">
                <div class="activity-feed">
                    {% for payment in recent_payments %}
                    <div class="feed-item">
                        <div class="date">{{ payment.payment_date|date:"d M Y" }}</div>
                        <div class="text">
                            {{ payment.student.first_name }} {{ payment.student.last_name }} -
                            â‚¹{{ payment.amount_paid|floatformat:2 }}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-muted">No recent payments</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if user.is_superuser or user.is_staff %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    window.addEventListener('load', function () {
    console.log('Window loaded - Setting up chart');

    // Get attendance data directly from the context
    
context = {
    'attendance_chart_data': {
        'labels': json.dumps(labels),
        'student_present': json.dumps(student_present),
        'student_absent': json.dumps(student_absent),
        'teacher_present': json.dumps(teacher_present),
        'teacher_absent': json.dumps(teacher_absent),
        'start_date': start_date.strftime('%Y-%m-%d'),
        'end_date': end_date.strftime('%Y-%m-%d'),
    }
}

    console.log('Data loaded:', attendanceData);
    });

    // Store the attendance data
    let attendanceData = {
        labels: labels,
        studentPresent: studentPresent,
        studentAbsent: studentAbsent,
        teacherPresent: teacherPresent,
        teacherAbsent: teacherAbsent,
        startDate: startDate,
        endDate: endDate
    };

    // Current view state
    let currentView = 'all';

    // Get elements
    const tooltipEl = document.getElementById('tooltip');
    const chartCanvas = document.getElementById('attendanceChart');

    if (!tooltipEl || !chartCanvas) {
        console.error('Required elements not found');
        return;
    }

    const ctx = chartCanvas.getContext('2d');

    // Chart configuration
    const config = {
        type: 'bar',
        data: {
            labels: attendanceData.labels,
            datasets: [
                {
                    label: 'Students Present',
                    data: attendanceData.studentPresent,
                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                    borderColor: '#28a745',
                    borderWidth: 2,
                    borderRadius: 4,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8,
                    order: 1
                },
                {
                    label: 'Students Absent',
                    data: attendanceData.studentAbsent,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: '#dc3545',
                    borderWidth: 2,
                    borderRadius: 4,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8,
                    order: 2
                },
                {
                    label: 'Teachers Present',
                    data: attendanceData.teacherPresent,
                    type: 'line',
                    backgroundColor: 'rgba(0, 123, 255, 0.7)',
                    borderColor: '#007bff',
                    borderWidth: 3,
                    pointBackgroundColor: '#007bff',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.4,
                    order: 0
                },
                {
                    label: 'Teachers Absent',
                    data: attendanceData.teacherAbsent,
                    type: 'line',
                    backgroundColor: 'rgba(255, 193, 7, 0.7)',
                    borderColor: '#ffc107',
                    borderWidth: 3,
                    pointBackgroundColor: '#ffc107',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.4,
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    enabled: false,
                    external: function (context) {
                        const { chart, tooltip } = context;

                        if (tooltip.opacity === 0) {
                            tooltipEl.style.display = 'none';
                            return;
                        }

                        if (tooltip.body) {
                            const title = tooltip.title[0];
                            const dataPoints = tooltip.body.map(b => b.lines[0]);

                            // Create tooltip content
                            let tooltipContent = `<div style="font-weight: bold; margin-bottom: 6px;">${title}</div>`;

                            // Add each data point with appropriate color
                            if (dataPoints.length > 0 && !attendanceChart.data.datasets[0].hidden) {
                                tooltipContent += `<div style="color: #28a745; margin-bottom: 4px;"><span style="display:inline-block;width:10px;height:10px;background:#28a745;margin-right:5px;border-radius:50%;"></span>${dataPoints[0]}</div>`;
                            }
                            if (dataPoints.length > 1 && !attendanceChart.data.datasets[1].hidden) {
                                tooltipContent += `<div style="color: #dc3545; margin-bottom: 4px;"><span style="display:inline-block;width:10px;height:10px;background:#dc3545;margin-right:5px;border-radius:50%;"></span>${dataPoints[1]}</div>`;
                            }
                            if (dataPoints.length > 2 && !attendanceChart.data.datasets[2].hidden) {
                                tooltipContent += `<div style="color: #007bff; margin-bottom: 4px;"><span style="display:inline-block;width:10px;height:10px;background:#007bff;margin-right:5px;border-radius:50%;"></span>${dataPoints[2]}</div>`;
                            }
                            if (dataPoints.length > 3 && !attendanceChart.data.datasets[3].hidden) {
                                tooltipContent += `<div style="color: #ffc107; margin-bottom: 4px;"><span style="display:inline-block;width:10px;height:10px;background:#ffc107;margin-right:5px;border-radius:50%;"></span>${dataPoints[3]}</div>`;
                            }

                            tooltipEl.innerHTML = tooltipContent;

                            // Position tooltip
                            const { offsetLeft: positionX, offsetTop: positionY } = chart.canvas;

                            tooltipEl.style.display = 'block';
                            tooltipEl.style.left = positionX + tooltip.caretX + 'px';
                            tooltipEl.style.top = positionY + tooltip.caretY - 120 + 'px';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Dates',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    title: {
                        display: true,
                        text: 'Number of Attendees',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        precision: 0,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    };

    // Initialize chart
    let attendanceChart = new Chart(ctx, config);
    console.log('Chart initialized');

    // Function to update visible datasets based on the current view
    function updateVisibleDatasets() {
        switch (currentView) {
            case 'students':
                attendanceChart.data.datasets[0].hidden = false; // Student Present
                attendanceChart.data.datasets[1].hidden = false; // Student Absent
                attendanceChart.data.datasets[2].hidden = true;  // Teacher Present
                attendanceChart.data.datasets[3].hidden = true;  // Teacher Absent
                break;
            case 'teachers':
                attendanceChart.data.datasets[0].hidden = true;  // Student Present
                attendanceChart.data.datasets[1].hidden = true;  // Student Absent
                attendanceChart.data.datasets[2].hidden = false; // Teacher Present
                attendanceChart.data.datasets[3].hidden = false; // Teacher Absent
                break;
            case 'present':
                attendanceChart.data.datasets[0].hidden = false; // Student Present
                attendanceChart.data.datasets[1].hidden = true;  // Student Absent
                attendanceChart.data.datasets[2].hidden = false; // Teacher Present
                attendanceChart.data.datasets[3].hidden = true;  // Teacher Absent
                break;
            case 'absent':
                attendanceChart.data.datasets[0].hidden = true;  // Student Present
                attendanceChart.data.datasets[1].hidden = false; // Student Absent
                attendanceChart.data.datasets[2].hidden = true;  // Teacher Present
                attendanceChart.data.datasets[3].hidden = false; // Teacher Absent
                break;
            case 'all':
            default:
                attendanceChart.data.datasets[0].hidden = false; // Student Present
                attendanceChart.data.datasets[1].hidden = false; // Student Absent
                attendanceChart.data.datasets[2].hidden = false; // Teacher Present
                attendanceChart.data.datasets[3].hidden = false; // Teacher Absent
                break;
        }

        attendanceChart.update();
        console.log('Chart view updated to:', currentView);
    }

    // Function to fetch new attendance data for a specific date range
    async function fetchAttendanceData(startDate, endDate) {
        try {
            // Show loading state
            const updateButton = document.getElementById('updateDateRange');
            if (!updateButton) {
                console.error('Update button not found');
                return false;
            }

            updateButton.disabled = true;
            updateButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

            console.log(`Fetching attendance data from ${startDate} to ${endDate}`);

            const response = await fetch(`/api/attendance/?start_date=${startDate}&end_date=${endDate}`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API error (${response.status}): ${errorText}`);
                throw new Error(`Failed to fetch attendance data: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Received data:', data);

            // Update attendance data
            attendanceData = {
                labels: data.labels,
                studentPresent: data.student_present,
                studentAbsent: data.student_absent,
                teacherPresent: data.teacher_present,
                teacherAbsent: data.teacher_absent,
                startDate: data.start_date,
                endDate: data.end_date
            };

            // Update chart data
            attendanceChart.data.labels = attendanceData.labels;
            attendanceChart.data.datasets[0].data = attendanceData.studentPresent;
            attendanceChart.data.datasets[1].data = attendanceData.studentAbsent;
            attendanceChart.data.datasets[2].data = attendanceData.teacherPresent;
            attendanceChart.data.datasets[3].data = attendanceData.teacherAbsent;

            // Update view based on current selection
            updateVisibleDatasets();

            // Reset button state
            updateButton.disabled = false;
            updateButton.textContent = 'Apply';

            console.log('Chart updated with new data');
            return true;
        } catch (error) {
            console.error('Error fetching attendance data:', error);

            const updateButton = document.getElementById('updateDateRange');
            if (updateButton) {
                updateButton.disabled = false;
                updateButton.textContent = 'Apply';
            }

            alert(`Failed to fetch attendance data: ${error.message}`);
            return false;
        }
    }

    // Set initial values for date inputs
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    if (startDateInput && attendanceData.startDate) {
        startDateInput.value = attendanceData.startDate;
    }

    if (endDateInput && attendanceData.endDate) {
        endDateInput.value = attendanceData.endDate;
    }

    // Add event listeners

    // View selector
    const viewSelector = document.getElementById('chartViewSelector');
    if (viewSelector) {
        viewSelector.addEventListener('change', function (e) {
            currentView = e.target.value;
            console.log('View changed to:', currentView);
            updateVisibleDatasets();
        });
    }

    // Date range update
    const updateButton = document.getElementById('updateDateRange');
    if (updateButton) {
        updateButton.addEventListener('click', function (e) {
            e.preventDefault();

            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            console.log('Date range button clicked:', startDate, 'to', endDate);

            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date.');
                return;
            }

            fetchAttendanceData(startDate, endDate);
        });
    }

    // Print PDF functionality
    const printButton = document.getElementById('printAttendanceChart');
    if (printButton) {
        printButton.addEventListener('click', function () {
            console.log('Print button clicked');

            // Create a new window for printing
            const printWindow = window.open('', '_blank');

            // Get the canvas as an image
            const chartImage = chartCanvas.toDataURL('image/png');

            // Generate HTML content for the print window
            let htmlContent = `
                                    <!DOCTYPE html>
                                    <html>
                                    <head>
                                        <title>Attendance Report (${attendanceData.startDate} to ${attendanceData.endDate})</title>
                                        <style>
                                            body { font-family: Arial, sans-serif; padding: 20px; }
                                            .header { text-align: center; margin-bottom: 20px; }
                                            .chart-container { text-align: center; margin: 20px 0; }
                                            .date-range { font-size: 16px; color: #666; margin-bottom: 20px; text-align: center; }
                                            .footer { margin-top: 30px; font-size: 12px; color: #999; text-align: center; }
                                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                            th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
                                            th { background-color: #f2f2f2; }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="header">
                                            <h1>Attendance Report</h1>
                                        </div>
                                        <div class="date-range">
                                            Period: ${attendanceData.startDate} to ${attendanceData.endDate}
                                        </div>
                                        <div class="chart-container">
                                            <img src="${chartImage}" alt="Attendance Chart" style="max-width: 100%;">
                                        </div>
                                        <div class="summary">
                                            <h2>Summary</h2>
                                            <table>
                                                <tr>
                                                    <th>Category</th>
                                                    <th>Average</th>
                                                </tr>
                                                <tr>
                                                    <td>Student Attendance Rate</td>
                                                    <td>${calculateAttendanceRate('student')}%</td>
                                                </tr>
                                                <tr>
                                                    <td>Teacher Attendance Rate</td>
                                                    <td>${calculateAttendanceRate('teacher')}%</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="footer">
                                            <p>Generated on: ${new Date().toLocaleString()}</p>
                                            <p>School Management System</p>
                                        </div>
                                    </body>
                                    </html>
                                `;

            // Function to calculate attendance rate
            function calculateAttendanceRate(type) {
                let totalPresent = 0;
                let totalAbsent = 0;

                if (type === 'student') {
                    attendanceData.studentPresent.forEach(val => totalPresent += val);
                    attendanceData.studentAbsent.forEach(val => totalAbsent += val);
                } else {
                    attendanceData.teacherPresent.forEach(val => totalPresent += val);
                    attendanceData.teacherAbsent.forEach(val => totalAbsent += val);
                }

                const total = totalPresent + totalAbsent;
                if (total === 0) return '0.0';

                return ((totalPresent / total) * 100).toFixed(1);
            }

            // Write the HTML content to the print window
            printWindow.document.open();
            printWindow.document.write(htmlContent);
            printWindow.document.close();

            // Wait for the image to load before printing
            setTimeout(() => {
                printWindow.print();
            }, 500);
        });
    }

</script>
{% endif %}
{% endblock %}